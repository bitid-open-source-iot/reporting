<mat-toolbar color="primary">
    <div class="spacer">
        widget editor
    </div>
    
    <button type="button" mat-icon-button (click)="close()">
        <mat-icon>
            close
        </mat-icon>
    </button>
</mat-toolbar>

<mat-progress-bar mode="indeterminate" color="accent" *ngIf="loading"></mat-progress-bar>

<div class="page-body">
    <div class="container">
        <form [formGroup]="form" (ngSubmit)="!form.invalid && submit()">
            <section>
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        label
                    </mat-label>
                    
                    <input matInput type="text" name="label" placeholder="label" formControlName="label" required>

                    <mat-error *ngIf="errors.label.label">
                        {{ errors.label.label }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        display type
                    </mat-label>
                    
                    <mat-select name="type" placeholder="display type" formControlName="type" required>
                        <mat-option value="map" disabled>
                            Map
                        </mat-option>
                        <mat-option value="table" disabled>
                            Table
                        </mat-option>
                        <mat-option value="gauge" disabled>
                            Gauge
                        </mat-option>
                        <mat-option value="image">
                            Image
                        </mat-option>
                        <mat-option value="chart">
                            Chart
                        </mat-option>
                        <mat-option value="value">
                            Value
                        </mat-option>
                        <mat-option value="text">
                            Free Text
                        </mat-option>
                    </mat-select>

                    <mat-error *ngIf="errors.type">
                        {{ errors.type }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                filter
            </h2>

            <section formGroupName="query" *ngIf="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        device
                    </mat-label>
                    
                    <mat-select name="deviceId" placeholder="device" formControlName="deviceId" [required]="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                        <mat-option *ngFor="let device of devices | orderBy : 'description'" [value]="device.deviceId">
                            {{ device.description }}
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.query.deviceId">
                        {{ errors.query.deviceId }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        input
                    </mat-label>
                    
                    <mat-select name="inputId" placeholder="input" formControlName="inputId" [required]="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                        <mat-option *ngFor="let input of inputs | orderBy : 'description'" [value]="input.inputId">
                            {{ input.description }}
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.query.inputId">
                        {{ errors.query.inputId }}
                    </mat-error>
                </mat-form-field>
            </section>

            <section formGroupName="query" *ngIf="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        counter
                    </mat-label>
                    
                    <mat-select name="counter" placeholder="counter" formControlName="counter" [required]="form.value.type == 'value' || form.value.type == 'gauge' || form.value.type == 'chart' || form.value.type == 'table'">
                        <mat-option [value]="true">
                            Is Counter
                        </mat-option>
                        <mat-option [value]="false">
                            Not Counter
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.query.counter">
                        {{ errors.query.counter }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.type == 'chart'">
                chart settings
            </h2>

            <section formGroupName="chart" *ngIf="form.value.type == 'chart'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        type
                    </mat-label>
                    
                    <mat-select name="type" placeholder="type" formControlName="type" [required]="form.value.type == 'chart'">
                        <mat-option value="bar">
                            Bar
                        </mat-option>
                        <mat-option value="area">
                            Area
                        </mat-option>
                        <mat-option value="line">
                            Line
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.chart.type">
                        {{ errors.chart.type }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        color
                    </mat-label>
                    
                    <input matInput type="color" name="color" placeholder="color" formControlName="color" [required]="form.value.type == 'chart'">
    
                    <mat-error *ngIf="errors.chart.color">
                        {{ errors.chart.color }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.type == 'value'">
                value settings
            </h2>

            <section formGroupName="value" *ngIf="form.value.type == 'value'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        expression
                    </mat-label>
                    
                    <mat-select name="expression" placeholder="expression" formControlName="expression" [required]="form.value.type == 'value'">
                        <mat-option value="last-value">
                            Last Value
                        </mat-option>
                        <mat-option value="first-value">
                            First Value
                        </mat-option>
                        <mat-option value="predicted-value">
                            Predicted Value
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.value.expression">
                        {{ errors.value.expression }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        color
                    </mat-label>
                    
                    <input matInput type="color" color-input name="color" placeholder="color" formControlName="color" [required]="form.value.type == 'value'">
    
                    <mat-error *ngIf="errors.value.color">
                        {{ errors.value.color }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.type == 'text'">
                free text settings
            </h2>

            <mat-form-field appearance="outline" formGroupName="text" *ngIf="form.value.type == 'text'">
                <mat-label text-uppercase>
                    value
                </mat-label>
                
                <textarea matInput [matTextareaAutosize]="true" rows="5" name="value" placeholder="value" formControlName="value" [required]="form.value.type == 'text'"></textarea>

                <mat-error *ngIf="errors.text.value">
                    {{ errors.text.value }}
                </mat-error>
            </mat-form-field>

            <h2 *ngIf="form.value.type == 'image'">
                image settings
            </h2>

            <div *ngIf="form.value.type == 'image'" class="image-upload" [style.background-image]="'url(' + form.value.image.src + ')'" (click)="upload()" matRipple></div>
        </form>

        <div class="conditions">
            <h2>
                conditions
            </h2>

            <div class="condition" *ngFor="let condition of conditions">
                <div class="widget-container" [style.background-color]="theme.board">
                    <widget [fill]="condition.fill" [stroke]="condition.stroke">
                        <banner [font]="condition.banner">
                            {{ form.value.label }}
                        </banner>
    
                        <value [font]="condition.font">
                            100%
                        </value>
                    </widget>
                </div>

                <div class="details">
                    <h3>
                        {{ GetDeviceDescription(condition.connector.deviceId) }}
                    </h3>
                    <p>
                        {{ GetDeviceInputDescription(condition.connector.deviceId, condition.connector.inputId) }}: {{ condition.connector.type == 'analog' ? (condition.connector.analog.min + condition.connector.analog.units + ' - ' + condition.connector.analog.max + condition.connector.analog.units) : (condition.connector.digital.value == 0 ? condition.connector.digital.low : condition.connector.digital.high) }}
                    </p>
                </div>

                <div class="options">
                    <button mat-icon-button matTooltip="Edit Condition" (click)="EditCondition('edit', condition)">
                        <mat-icon svgIcon="edit"></mat-icon>
                    </button>

                    <button mat-icon-button matTooltip="Copy Condition" (click)="EditCondition('copy', condition)">
                        <mat-icon svgIcon="copy"></mat-icon>
                    </button>
    
                    <button mat-icon-button matTooltip="Remove Condition" color="warn"(click)="RemoveCondition(condition.conditionId)">
                        <mat-icon svgIcon="delete"></mat-icon>
                    </button>
                </div>
            </div>

            <div class="add condition" matRipple matTooltip="Add Condition" (click)="EditCondition('add')">
                <mat-icon>
                    add
                </mat-icon>
            </div>
        </div>
    </div>
</div>