<mat-toolbar color="primary">
    <div class="spacer">
        widget editor
    </div>
    
    <button type="button" mat-icon-button (click)="close()">
        <mat-icon>
            close
        </mat-icon>
    </button>
</mat-toolbar>

<mat-progress-bar mode="indeterminate" color="accent" *ngIf="loading"></mat-progress-bar>

<div class="page-body">
    <div class="container">
        <form [formGroup]="form" (ngSubmit)="!form.invalid && submit()">
            <section>
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        label
                    </mat-label>
                    
                    <input matInput type="text" name="label" placeholder="label" formControlName="label" required>

                    <mat-error *ngIf="errors.label.label">
                        {{ errors.label.label }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        display type
                    </mat-label>
                    
                    <mat-select name="display" placeholder="display type" formControlName="display" required>
                        <mat-option *ngFor="let display of displays" [value]="display">
                            {{ display }}
                        </mat-option>
                    </mat-select>

                    <mat-error *ngIf="errors.display">
                        {{ errors.display }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.display == 'value' || form.value.display == 'gauge' || form.value.display == 'chart' || form.value.display == 'table'">
                connector
            </h2>

            <section formGroupName="query" *ngIf="form.value.display == 'value' || form.value.display == 'gauge' || form.value.display == 'chart' || form.value.display == 'table'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        device
                    </mat-label>
                    
                    <input type="text" matInput [(ngModel)]="filter.device" [ngModelOptions]="{standalone: true}" [matAutocomplete]="deviceautocomplete" [required]="form.value.display == 'value' || form.value.display == 'gauge' || form.value.display == 'chart' || form.value.display == 'table'">

                    <mat-autocomplete #deviceautocomplete="matAutocomplete">
                        <mat-option *ngFor="let device of devices.data | orderBy : 'description' | filterBy: 'description' : filter.device" [value]="device.description" (click)="SetDeviceId(device.deviceId)">
                            {{ device.description }}
                        </mat-option>
                    </mat-autocomplete>
    
                    <mat-error *ngIf="errors.query.deviceId">
                        {{ errors.query.deviceId }}
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        input
                    </mat-label>
                    
                    <input type="text" matInput [(ngModel)]="filter.input" [ngModelOptions]="{standalone: true}" [matAutocomplete]="inputautocomplete" [required]="form.value.display == 'value' || form.value.display == 'gauge' || form.value.display == 'chart' || form.value.display == 'table'">

                    <mat-autocomplete #inputautocomplete="matAutocomplete">
                        <mat-option *ngFor="let input of inputs | orderBy : 'description' | filterBy: 'description' : filter.input" [value]="input.description" (click)="SetInputId(input.inputId)">
                            {{ input.description }}
                        </mat-option>
                    </mat-autocomplete>
    
                    <mat-error *ngIf="errors.query.inputId">
                        {{ errors.query.inputId }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.display == 'chart'">
                chart settings
            </h2>

            <section formGroupName="chart" *ngIf="form.value.display == 'chart'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        type
                    </mat-label>
                    
                    <mat-select name="type" placeholder="type" formControlName="type" [required]="form.value.display == 'chart'">
                        <mat-option value="bar">
                            Bar
                        </mat-option>
                        <mat-option value="area">
                            Area
                        </mat-option>
                        <mat-option value="line">
                            Line
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.chart.type">
                        {{ errors.chart.type }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.display == 'value'">
                value settings
            </h2>

            <section formGroupName="value" *ngIf="form.value.display == 'value'">
                <mat-form-field appearance="outline">
                    <mat-label text-uppercase>
                        expression
                    </mat-label>
                    
                    <mat-select name="expression" placeholder="expression" formControlName="expression" [required]="form.value.display == 'value'">
                        <mat-option value="last-value">
                            Last Value
                        </mat-option>
                        <mat-option value="first-value">
                            First Value
                        </mat-option>
                        <mat-option value="predicted-value">
                            Predicted Value
                        </mat-option>
                    </mat-select>
    
                    <mat-error *ngIf="errors.value.expression">
                        {{ errors.value.expression }}
                    </mat-error>
                </mat-form-field>
            </section>

            <h2 *ngIf="form.value.display == 'text'">
                text settings
            </h2>

            <mat-form-field appearance="outline" formGroupName="text" *ngIf="form.value.display == 'text'">
                <mat-label text-uppercase>
                    value
                </mat-label>
                
                <textarea matInput [matTextareaAutosize]="true" rows="5" name="value" placeholder="value" formControlName="value" [required]="form.value.display == 'text'"></textarea>

                <mat-error *ngIf="errors.text.value">
                    {{ errors.text.value }}
                </mat-error>
            </mat-form-field>

            <h2 *ngIf="form.value.display == 'image'">
                image settings
            </h2>

            <div *ngIf="form.value.display == 'image'" class="image-upload" [style.background-image]="'url(' + form.value.image.src + ')'" (click)="upload()" matRipple></div>

            <div class="conditions" *ngIf="form.value.display">
                <h2>
                    conditional formatting
                </h2>

                <div class="condition" *ngFor="let condition of form.value.conditions">
                    <blox class="widget-container" [fill]="theme.board">
                        <row [height]="height">
                            <column width="100" [fill]="condition.fill" [font]="condition.font" [stroke]="condition.stroke">
                                <banner [font]="condition.banner">
                                    {{ form.value.label }}
                                </banner>
            
                                <text *ngIf="form.value.display == 'text'" [font]="condition.font" [style.top.px]="condition.banner.size + 10" [style.left.px]="condition.banner.size" [style.right.px]="condition.banner.size" [style.bottom.px]="condition.banner.size">
                                    TEXT HERE
                                </text>
                
                                <value *ngIf="form.value.display == 'value'" [font]="condition.font">
                                    VALUE HERE
                                </value>
                
                                <image *ngIf="form.value.display == 'image'" [src]="form.value.image.src"></image>
                
                                <chart *ngIf="form.value.display == 'chart'" [type]="form.value.chart.type" [data]="chart" units="%" [font]="condition.font" [label]="form.value.label" format="YYYY/MM/DD" [chartfill]="condition.chartfill" [gridlines]="condition.gridlines"></chart>
                            </column>
                        </row>
                    </blox>

                    <div class="details" *ngIf="condition.type == 'connector'">
                        <h3>
                            {{ GetDeviceDescription(condition.connector.deviceId) }}
                        </h3>
                        <p>
                            {{ GetDeviceInputDescription(condition.connector.deviceId, condition.connector.inputId) }}: {{ condition.connector.type == 'analog' ? (condition.connector.analog.min + condition.connector.analog.units + ' - ' + condition.connector.analog.max + condition.connector.analog.units) : (condition.connector.digital.value == 0 ? condition.connector.digital.low : condition.connector.digital.high) }}
                        </p>
                    </div>

                    <div class="details" *ngIf="condition.type == 'default'">
                        <h3>
                            default
                        </h3>
                    </div>

                    <div class="options">
                        <button type="button" mat-icon-button matTooltip="Edit Condition" (click)="edit('edit', condition)">
                            <mat-icon svgIcon="edit"></mat-icon>
                        </button>

                        <button type="button" mat-icon-button matTooltip="Copy Condition" (click)="edit('copy', condition)">
                            <mat-icon svgIcon="copy"></mat-icon>
                        </button>
        
                        <button type="button" mat-icon-button matTooltip="Remove Condition" color="warn"(click)="remove(condition)">
                            <mat-icon svgIcon="delete"></mat-icon>
                        </button>
                    </div>
                </div>

                <div class="add condition" matRipple matTooltip="Add Condition" (click)="edit('add')">
                    <mat-icon>
                        add
                    </mat-icon>
                </div>
            </div>

            <button type="submit" color="primary" mat-flat-button>
                submit
            </button>
        </form>
    </div>
</div>